#!/bin/bash
# Pre-commit hook aligned with CI workflow
# Install: ./scripts/install-hooks.sh
# Or manually: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If running from .git/hooks, find the project root differently
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

echo "üîç Running pre-commit checks..."

cd "$PROJECT_ROOT"

# Format check
echo "  Checking formatting..."
if ! cargo fmt --all -- --check; then
    echo "‚ùå Formatting check failed. Run 'cargo fmt --all' to fix."
    exit 1
fi

# Clippy
echo "  Running Clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "‚ùå Clippy found issues. Fix the warnings above."
    exit 1
fi

# Unit tests (fast, no browser/server needed)
echo "  Running unit tests..."
if ! cargo test --all-features --workspace; then
    echo "‚ùå Unit tests failed."
    exit 1
fi

# Parity tests (fast, catches config drift between apps)
echo "  Running parity tests..."
if ! cargo test -p benchmark-harness --test parity_tests; then
    echo "‚ùå Parity tests failed. Apps may have diverged configs."
    exit 1
fi

# Browser tests (requires trunk servers)
# Skip if SKIP_BROWSER_TESTS is set or if we can't start servers
if [ -z "$SKIP_BROWSER_TESTS" ]; then
    echo "  Running browser integration tests..."
    if ! "$PROJECT_ROOT/scripts/test-browser.sh"; then
        echo "‚ùå Browser tests failed."
        echo "  To skip browser tests: SKIP_BROWSER_TESTS=1 git commit ..."
        exit 1
    fi
else
    echo "  ‚è≠Ô∏è  Skipping browser tests (SKIP_BROWSER_TESTS is set)"
fi

echo "‚úÖ All pre-commit checks passed!"
