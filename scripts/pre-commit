#!/bin/bash
# Pre-commit hook aligned with CI workflow
# Install: ./scripts/install-hooks.sh
# Or manually: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If running from .git/hooks, find the project root differently
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

echo "üîç Running pre-commit checks..."

cd "$PROJECT_ROOT"

# Format check
echo "  Checking formatting..."
if ! cargo fmt --all -- --check; then
    echo "‚ùå Formatting check failed. Run 'cargo fmt --all' to fix."
    exit 1
fi

# Clippy (with auto-fix for safe lints)
echo "  Running Clippy..."
CLIPPY_OUTPUT=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1) || {
    # Check if it's a simple/safe lint that can be auto-fixed (machine-applicable only)
    SAFE_LINTS="redundant_clone|needless_borrow|clone_on_copy|useless_conversion|needless_return"
    if echo "$CLIPPY_OUTPUT" | grep -qE "clippy::($SAFE_LINTS)"; then
        echo "  üîß Auto-fixing safe clippy lints..."
        cargo clippy --fix --allow-dirty --allow-staged --all-targets --all-features 2>/dev/null || true
        # Re-run clippy to verify fix worked
        if ! cargo clippy --all-targets --all-features -- -D warnings; then
            echo "‚ùå Clippy still has issues after auto-fix. Manual fix needed."
            exit 1
        fi
        echo "  ‚úÖ Auto-fix successful!"
    else
        echo "$CLIPPY_OUTPUT"
        echo "‚ùå Clippy found issues. Fix the warnings above."
        exit 1
    fi
}

# Unit tests (fast, no browser/server needed)
# Exclude browser tests - they require trunk servers and are slow
echo "  Running unit tests..."
if command -v cargo-nextest &> /dev/null; then
    if ! cargo nextest run --all-features --workspace -E 'not binary(browser_pdfjoin) and not binary(browser_agentpdf) and not binary(browser_docsign) and not binary(browser_core)'; then
        echo "‚ùå Unit tests failed."
        exit 1
    fi
else
    # Without nextest, exclude benchmark-harness entirely and run its non-browser tests separately
    if ! cargo test --all-features --workspace --exclude benchmark-harness; then
        echo "‚ùå Unit tests failed."
        exit 1
    fi
    # Run only parity and benchmark tests from benchmark-harness (skip browser_* tests)
    if ! cargo test -p benchmark-harness --test parity_tests --test pdfjoin_benchmark; then
        echo "‚ùå Unit tests failed."
        exit 1
    fi
fi

# Browser tests (requires trunk servers) - DISABLED by default, too slow/flaky for pre-commit
# Run manually with: ./scripts/test-browser.sh
# Or enable with: ENABLE_BROWSER_TESTS=1 git commit ...
if [ -n "$ENABLE_BROWSER_TESTS" ]; then
    echo "  Running browser integration tests..."
    if ! "$PROJECT_ROOT/scripts/test-browser.sh"; then
        echo "‚ùå Browser tests failed."
        exit 1
    fi
else
    echo "  ‚è≠Ô∏è  Skipping browser tests (run ./scripts/test-browser.sh manually)"
fi

echo "‚úÖ All pre-commit checks passed!"
