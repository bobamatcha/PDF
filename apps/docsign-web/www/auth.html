<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sign in or create an account for Get Signatures">
    <title>Sign In - Get Signatures</title>
    <link rel="stylesheet" href="geriatric.css">
    <style>
        /* Auth page specific styles - follows geriatric.css patterns */
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: white;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --border-primary: #d1d5db;
            --accent-primary: #0056b3;
            --accent-hover: #003d82;
            --error: #b30000;
            --error-bg: #fce8e8;
            --success: #006644;
            --success-bg: #e6f4ed;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 18px;
            line-height: 1.6;
        }

        .header {
            background: var(--accent-primary);
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .container {
            max-width: 500px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .auth-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: #f0f0f0;
            border-radius: 12px;
            padding: 4px;
        }

        .auth-tab {
            flex: 1;
            padding: 0.875rem 1rem;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            min-height: 52px;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .auth-tab:hover {
            color: var(--text-primary);
        }

        .auth-tab.active {
            background: white;
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .auth-tab:focus {
            outline: none;
        }

        .auth-tab:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* CRITICAL: Override geriatric.css dark mode for form inputs
           Elderly users need WHITE backgrounds with DARK text - always */
        .form-input,
        input[type="text"].form-input,
        input[type="email"].form-input,
        input[type="password"].form-input {
            width: 100%;
            padding: 1rem;
            font-size: 18px;
            border: 2px solid #d1d5db !important;
            border-radius: 8px;
            background: #ffffff !important;
            background-color: #ffffff !important;
            color: #1a1a1a !important;
            min-height: 60px;
        }

        .form-input:focus,
        input[type="text"].form-input:focus,
        input[type="email"].form-input:focus,
        input[type="password"].form-input:focus {
            outline: none;
            border-color: #0056b3 !important;
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.2);
        }

        .form-input.error {
            border-color: #b30000 !important;
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        .form-hint {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .form-error {
            font-size: 16px;
            color: var(--error);
            margin-top: 0.5rem;
            display: none;
        }

        .form-error.visible {
            display: block;
        }

        .btn {
            width: 100%;
            padding: 1rem 2rem;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            min-height: 60px;
            transition: background-color 0.2s ease;
        }

        .btn:focus {
            outline: 4px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
            min-height: 60px;
            font-size: 20px;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-link {
            background: none;
            color: var(--accent-primary);
            text-decoration: underline;
            padding: 0.5rem;
            min-height: auto;
            width: auto;
            display: inline;
        }

        .btn-link:hover {
            color: var(--accent-hover);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 18px;
            display: none;
        }

        .alert.visible {
            display: block;
        }

        .alert-error {
            background: var(--error-bg);
            color: var(--error);
            border: 2px solid var(--error);
        }

        .alert-success {
            background: var(--success-bg);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .forgot-password-link {
            text-align: center;
            margin-top: 1rem;
        }

        .password-requirements {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding-left: 1rem;
        }

        .password-requirements li {
            margin-bottom: 0.25rem;
        }

        .password-requirements li.valid {
            color: var(--success);
        }

        .password-requirements li.invalid {
            color: var(--text-secondary);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .back-link {
            text-align: center;
            margin-top: 2rem;
        }

        /* Verification and reset pages */
        .message-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .message-card h2 {
            font-size: 24px;
            margin-bottom: 1rem;
        }

        .message-card p {
            font-size: 18px;
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        /* Show password toggle - placed BELOW input to avoid browser password manager icon overlap */
        .password-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .password-wrapper .form-input {
            width: 100%;
        }

        .show-password-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .show-password-toggle input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .show-password-toggle label {
            font-size: 16px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .show-password-toggle:hover label {
            color: var(--accent-primary);
        }

        /* Documents remaining badge */
        .docs-remaining {
            display: inline-block;
            background: var(--success-bg);
            color: var(--success);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Email exists alert - for email-first UX */
        .email-exists-alert {
            background: #fff8e6;
            border: 2px solid #d69e2e;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.75rem;
        }

        .email-exists-alert p {
            font-size: 16px;
            color: #744210;
            margin-bottom: 1rem;
        }

        .email-exists-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .email-exists-actions .btn {
            width: 100%;
            text-align: center;
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }

        /* Desktop: side-by-side buttons */
        @media (min-width: 500px) {
            .email-exists-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .email-exists-actions .btn {
                flex: 1;
                min-width: 140px;
                width: auto;
            }
        }

        /* Secondary button style */
        .btn-secondary {
            background: white;
            color: var(--accent-primary);
            border: 2px solid var(--accent-primary);
        }

        .btn-secondary:hover {
            background: #f0f7ff;
        }

        /* Email checking spinner */
        .email-checking {
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Get Signatures</h1>
    </header>

    <main class="container">
        <!-- Alert messages -->
        <div id="alert" class="alert" role="alert" aria-live="polite"></div>

        <!-- Main auth card -->
        <div class="auth-card" id="authCard">
            <!-- Tab navigation -->
            <div class="auth-tabs" role="tablist">
                <button class="auth-tab active"
                        id="loginTab"
                        role="tab"
                        aria-selected="true"
                        aria-controls="loginForm"
                        onclick="showForm('login')">
                    Sign In
                </button>
                <button class="auth-tab"
                        id="registerTab"
                        role="tab"
                        aria-selected="false"
                        aria-controls="registerForm"
                        onclick="showForm('register')">
                    Create Account
                </button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" role="tabpanel" aria-labelledby="loginTab" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email Address</label>
                    <input type="email"
                           id="loginEmail"
                           class="form-input"
                           required
                           autocomplete="email"
                           placeholder="Enter your email">
                </div>

                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <div class="password-wrapper">
                        <input type="password"
                               id="loginPassword"
                               class="form-input"
                               required
                               autocomplete="current-password"
                               placeholder="Enter your password">
                        <div class="show-password-toggle">
                            <input type="checkbox" id="showLoginPassword" onchange="togglePasswordCheckbox('loginPassword', this.checked)">
                            <label for="showLoginPassword">Show password</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn">
                    Sign In
                </button>

                <div class="forgot-password-link">
                    <button type="button" class="btn-link" onclick="showForm('forgot')">
                        Forgot your password?
                    </button>
                </div>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" role="tabpanel" aria-labelledby="registerTab" onsubmit="handleRegister(event)">
                <!-- Name fields row -->
                <div class="form-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <div style="flex: 2; min-width: 140px;">
                        <label class="form-label" for="registerFirstName">First Name</label>
                        <input type="text"
                               id="registerFirstName"
                               class="form-input"
                               required
                               autocomplete="given-name"
                               placeholder="First name">
                    </div>
                    <div style="flex: 1; min-width: 80px; max-width: 100px;">
                        <label class="form-label" for="registerMiddleInitial">M.I.</label>
                        <input type="text"
                               id="registerMiddleInitial"
                               class="form-input"
                               maxlength="2"
                               autocomplete="additional-name"
                               placeholder="MI"
                               style="text-transform: uppercase;">
                    </div>
                    <div style="flex: 2; min-width: 140px;">
                        <label class="form-label" for="registerLastName">Last Name</label>
                        <input type="text"
                               id="registerLastName"
                               class="form-input"
                               required
                               autocomplete="family-name"
                               placeholder="Last name">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerEmail">Email Address</label>
                    <input type="email"
                           id="registerEmail"
                           class="form-input"
                           required
                           autocomplete="email"
                           placeholder="Enter your email"
                           onblur="checkEmailOnBlur(this.value)">
                    <p class="form-hint" id="emailHint">We'll send a verification link to this address</p>

                    <!-- Email exists alert - hidden by default -->
                    <div id="emailExistsAlert" class="email-exists-alert" style="display: none;">
                        <p id="emailExistsMessage">This email is already registered.</p>
                        <div class="email-exists-actions">
                            <button type="button" id="resendVerifyBtn" class="btn btn-primary" style="display: none;" onclick="resendVerificationFromAlert()">
                                Resend Verification Email
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showForm('login'); document.getElementById('loginEmail').value = document.getElementById('registerEmail').value;">
                                Sign In
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showForm('forgot'); document.getElementById('forgotEmail').value = document.getElementById('registerEmail').value;">
                                Reset Password
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Password fields - hidden when email exists -->
                <div id="passwordFields">
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Password</label>
                        <div class="password-wrapper">
                            <input type="password"
                                   id="registerPassword"
                                   class="form-input"
                                   required
                                   autocomplete="new-password"
                                   placeholder="Create a password"
                                   oninput="validatePasswordInput()">
                            <div class="show-password-toggle">
                                <input type="checkbox" id="showRegisterPassword" onchange="togglePasswordCheckbox('registerPassword', this.checked)">
                                <label for="showRegisterPassword">Show password</label>
                            </div>
                        </div>
                        <ul class="password-requirements" id="passwordRequirements">
                            <li id="req-length">At least 8 characters</li>
                            <li id="req-upper">One uppercase letter</li>
                            <li id="req-lower">One lowercase letter</li>
                            <li id="req-number">One number</li>
                        </ul>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="registerConfirm">Confirm Password</label>
                        <div class="password-wrapper">
                            <input type="password"
                                   id="registerConfirm"
                                   class="form-input"
                                   required
                                   autocomplete="new-password"
                                   placeholder="Confirm password">
                            <div class="show-password-toggle">
                                <input type="checkbox" id="showRegisterConfirm" onchange="togglePasswordCheckbox('registerConfirm', this.checked)">
                                <label for="showRegisterConfirm">Show password</label>
                            </div>
                        </div>
                        <p class="form-error" id="confirmError">Passwords do not match</p>
                    </div>

                    <button type="submit" class="btn btn-primary" id="registerBtn">
                        Create Account
                    </button>
                </div>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgotForm" class="auth-form" onsubmit="handleForgotPassword(event)">
                <h2 style="font-size: 24px; margin-bottom: 1rem;">Reset Password</h2>
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Enter your email address and we'll send you a link to reset your password.
                </p>

                <div class="form-group">
                    <label class="form-label" for="forgotEmail">Email Address</label>
                    <input type="email"
                           id="forgotEmail"
                           class="form-input"
                           required
                           autocomplete="email"
                           placeholder="Enter your email">
                </div>

                <button type="submit" class="btn btn-primary" id="forgotBtn">
                    Send Reset Link
                </button>

                <div style="text-align: center; margin-top: 1rem;">
                    <button type="button" class="btn-link" onclick="showForm('login')">
                        Back to Sign In
                    </button>
                </div>
            </form>

            <!-- Reset Password Form (shown when user clicks email link) -->
            <form id="resetPasswordForm" class="auth-form" onsubmit="handleResetPassword(event)">
                <h2 style="font-size: 24px; margin-bottom: 1rem;">Set New Password</h2>
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Enter your new password below.
                </p>
                <input type="hidden" id="resetToken" value="">

                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="password-wrapper">
                        <input type="password"
                               id="newPassword"
                               class="form-input"
                               required
                               autocomplete="new-password"
                               placeholder="Enter new password"
                               oninput="validateNewPasswordInput()">
                        <div class="show-password-toggle">
                            <input type="checkbox" id="showNewPassword" onchange="togglePasswordCheckbox('newPassword', this.checked)">
                            <label for="showNewPassword">Show password</label>
                        </div>
                    </div>
                    <ul class="password-requirements" id="newPasswordRequirements">
                        <li id="new-req-length">At least 8 characters</li>
                        <li id="new-req-upper">One uppercase letter</li>
                        <li id="new-req-lower">One lowercase letter</li>
                        <li id="new-req-number">One number</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmNewPassword">Confirm New Password</label>
                    <div class="password-wrapper">
                        <input type="password"
                               id="confirmNewPassword"
                               class="form-input"
                               required
                               autocomplete="new-password"
                               placeholder="Confirm new password">
                        <div class="show-password-toggle">
                            <input type="checkbox" id="showConfirmNewPassword" onchange="togglePasswordCheckbox('confirmNewPassword', this.checked)">
                            <label for="showConfirmNewPassword">Show password</label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="resetPasswordBtn">
                    Set New Password
                </button>
            </form>
        </div>
    </main>

    <!-- Scripts -->
    <script type="module" src="js/bundle.js"></script>
    <script>
        // Wait for DocSign to be available
        function waitForDocSign() {
            return new Promise((resolve) => {
                if (window.DocSign && window.DocSign.isAuthenticated) {
                    resolve();
                } else {
                    const check = setInterval(() => {
                        if (window.DocSign && window.DocSign.isAuthenticated) {
                            clearInterval(check);
                            resolve();
                        }
                    }, 50);
                }
            });
        }

        // Show/hide forms
        function showForm(formName) {
            const forms = document.querySelectorAll('.auth-form');
            const tabs = document.querySelectorAll('.auth-tab');

            forms.forEach(f => f.classList.remove('active'));
            tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });

            document.getElementById(formName + 'Form').classList.add('active');

            if (formName === 'login') {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('loginTab').setAttribute('aria-selected', 'true');
            } else if (formName === 'register') {
                document.getElementById('registerTab').classList.add('active');
                document.getElementById('registerTab').setAttribute('aria-selected', 'true');
            }

            hideAlert();
        }

        // Show alert message
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert visible alert-' + type;
        }

        // Show alert with resend verification button
        function showAlertWithResend(message, email) {
            const alertDiv = document.getElementById('alert');
            alertDiv.innerHTML = `
                <div style="margin-bottom: 12px;">${message}</div>
                <button onclick="resendVerification('${email}')"
                        class="resend-btn"
                        style="background: #4F46E5; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                    Resend Verification Email
                </button>
            `;
            alertDiv.className = 'alert alert-error visible';
        }

        // Resend verification email
        async function resendVerification(email) {
            try {
                const result = await window.DocSign.resendVerification(email);
                if (result.success) {
                    showAlert(result.message || 'Verification email sent! Please check your inbox.', 'success');
                } else {
                    showAlert(result.message || 'Failed to send email. Please try again.', 'error');
                }
            } catch (error) {
                showAlert('An error occurred. Please try again later.', 'error');
            }
        }

        // Resend verification from email-exists alert (uses email from register form)
        async function resendVerificationFromAlert() {
            const email = document.getElementById('registerEmail').value.trim();
            if (!email) {
                showAlert('Please enter your email address first.', 'error');
                return;
            }
            const btn = document.getElementById('resendVerifyBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Sending...';
            btn.disabled = true;
            try {
                await resendVerification(email);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Show rate limit countdown
        function showRateLimitCountdown(seconds) {
            const alertDiv = document.getElementById('alert');
            let remaining = seconds;

            const updateCountdown = () => {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                const timeStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;

                alertDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; margin-bottom: 8px;">
                            Too many attempts. Please wait before trying again.
                        </div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #4F46E5;">
                            ${timeStr}
                        </div>
                    </div>
                `;
                alertDiv.className = 'alert alert-error visible';

                if (remaining > 0) {
                    remaining--;
                    setTimeout(updateCountdown, 1000);
                } else {
                    showAlert('You can try again now!', 'success');
                }
            };

            updateCountdown();
        }

        // Hide alert
        function hideAlert() {
            document.getElementById('alert').classList.remove('visible');
        }

        // Email-first UX: Check if email exists on blur
        let emailCheckTimeout = null;
        async function checkEmailOnBlur(email) {
            // Clear any pending check
            if (emailCheckTimeout) {
                clearTimeout(emailCheckTimeout);
            }

            const emailHint = document.getElementById('emailHint');
            const emailExistsAlert = document.getElementById('emailExistsAlert');
            const emailExistsMessage = document.getElementById('emailExistsMessage');
            const passwordFields = document.getElementById('passwordFields');

            // Reset state
            emailExistsAlert.style.display = 'none';
            passwordFields.style.display = 'block';

            // Don't check empty or invalid emails
            if (!email || !email.includes('@') || email.length < 5) {
                emailHint.textContent = "We'll send a verification link to this address";
                emailHint.className = 'form-hint';
                return;
            }

            // Show checking state
            emailHint.textContent = 'Checking email...';
            emailHint.className = 'form-hint email-checking';

            // Debounce the check
            emailCheckTimeout = setTimeout(async () => {
                try {
                    await waitForDocSign();
                    const result = await window.DocSign.checkEmail(email);

                    if (result.exists) {
                        // Email exists - show options
                        emailHint.style.display = 'none';
                        passwordFields.style.display = 'none';
                        const resendBtn = document.getElementById('resendVerifyBtn');

                        if (result.verified) {
                            emailExistsMessage.textContent = 'This email is already registered.';
                            resendBtn.style.display = 'none';
                        } else {
                            emailExistsMessage.textContent = 'This email is registered but not verified.';
                            resendBtn.style.display = 'block';
                        }
                        emailExistsAlert.style.display = 'block';
                    } else {
                        // Email is new - show password fields
                        emailHint.textContent = "We'll send a verification link to this address";
                        emailHint.className = 'form-hint';
                        emailHint.style.display = 'block';
                        emailExistsAlert.style.display = 'none';
                        passwordFields.style.display = 'block';
                    }
                } catch (error) {
                    // On error, just show the form normally
                    console.error('Email check error:', error);
                    emailHint.textContent = "We'll send a verification link to this address";
                    emailHint.className = 'form-hint';
                    emailHint.style.display = 'block';
                    passwordFields.style.display = 'block';
                }
            }, 300); // 300ms debounce
        }

        // Toggle password visibility (checkbox-based to avoid browser password manager icon overlap)
        function togglePasswordCheckbox(inputId, show) {
            const input = document.getElementById(inputId);
            input.type = show ? 'text' : 'password';
        }

        // Validate password requirements in real-time
        function validatePasswordInput() {
            const password = document.getElementById('registerPassword').value;

            const checks = {
                'req-length': password.length >= 8,
                'req-upper': /[A-Z]/.test(password),
                'req-lower': /[a-z]/.test(password),
                'req-number': /[0-9]/.test(password)
            };

            for (const [id, valid] of Object.entries(checks)) {
                const el = document.getElementById(id);
                el.classList.toggle('valid', valid);
                el.classList.toggle('invalid', !valid);
            }
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            await waitForDocSign();

            const btn = document.getElementById('loginBtn');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Signing In...';

            try {
                const result = await window.DocSign.login(email, password);

                if (result.success) {
                    showAlert('Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    // Check if verification is needed - show resend button
                    if (result.needs_verification) {
                        showAlertWithResend(result.error || 'Please verify your email.', result.email || email);
                    } else {
                        showAlert(result.error || 'Login failed. Please check your email and password.', 'error');
                    }
                    btn.disabled = false;
                    btn.textContent = 'Sign In';
                }
            } catch (error) {
                // Check for rate limit (429)
                if (error.status === 429) {
                    const data = await error.json().catch(() => ({}));
                    showRateLimitCountdown(data.retry_after_seconds || 3600);
                } else {
                    showAlert('An error occurred. Please try again.', 'error');
                }
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            await waitForDocSign();

            const btn = document.getElementById('registerBtn');
            const firstName = document.getElementById('registerFirstName').value.trim();
            const middleInitial = document.getElementById('registerMiddleInitial').value.trim().toUpperCase();
            const lastName = document.getElementById('registerLastName').value.trim();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;

            // Construct full name for API (backend stores as single name field)
            const name = middleInitial
                ? `${firstName} ${middleInitial}. ${lastName}`
                : `${firstName} ${lastName}`;

            // Store individual name parts for recipient auto-population
            localStorage.setItem('docsign_user_names', JSON.stringify({
                firstName,
                middleInitial,
                lastName
            }));

            // Validate passwords match
            if (password !== confirm) {
                document.getElementById('confirmError').classList.add('visible');
                document.getElementById('registerConfirm').classList.add('error');
                return;
            } else {
                document.getElementById('confirmError').classList.remove('visible');
                document.getElementById('registerConfirm').classList.remove('error');
            }

            // Validate password strength
            const passwordError = window.DocSign.validatePassword(password);
            if (passwordError) {
                showAlert(passwordError, 'error');
                return;
            }

            // Validate email
            const emailError = window.DocSign.validateEmail(email);
            if (emailError) {
                showAlert(emailError, 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Creating Account...';

            try {
                const result = await window.DocSign.register(email, password, name);

                if (result.success) {
                    showAlert('Account created! Please check your email to verify your account.', 'success');
                    btn.textContent = 'Create Account';
                    btn.disabled = false;
                    // Switch to login form after short delay
                    setTimeout(() => {
                        showForm('login');
                        document.getElementById('loginEmail').value = email;
                    }, 2000);
                } else {
                    // Check if verification is needed (account exists but unverified)
                    if (result.needs_verification) {
                        showAlertWithResend(result.message || 'Please verify your email.', email);
                    } else {
                        showAlert(result.message || 'Registration failed. Please try again.', 'error');
                    }
                    btn.disabled = false;
                    btn.textContent = 'Create Account';
                }
            } catch (error) {
                // Check for rate limit (429)
                if (error.status === 429) {
                    const data = await error.json().catch(() => ({}));
                    showRateLimitCountdown(data.retry_after_seconds || 3600);
                } else {
                    showAlert('An error occurred. Please try again.', 'error');
                }
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        // Handle forgot password
        async function handleForgotPassword(event) {
            event.preventDefault();
            await waitForDocSign();

            const btn = document.getElementById('forgotBtn');
            const email = document.getElementById('forgotEmail').value;

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Sending...';

            try {
                const result = await window.DocSign.forgotPassword(email);
                // Show success or error based on result
                showAlert(result.message, result.success ? 'success' : 'error');
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            } catch (error) {
                showAlert('An error occurred. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        }

        // Handle reset password (from email link)
        async function handleResetPassword(event) {
            event.preventDefault();
            await waitForDocSign();

            const btn = document.getElementById('resetPasswordBtn');
            const token = document.getElementById('resetToken').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match.', 'error');
                return;
            }

            const validationError = window.DocSign.validatePassword(newPassword);
            if (validationError) {
                showAlert(validationError, 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Resetting...';

            try {
                const result = await window.DocSign.resetPassword(token, newPassword);
                if (result.success) {
                    showAlert('Password reset! You can now sign in.', 'success');
                    showForm('login');
                } else {
                    showAlert(result.message, 'error');
                }
                btn.disabled = false;
                btn.textContent = 'Set New Password';
            } catch (error) {
                showAlert('An error occurred. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Set New Password';
            }
        }

        // Validate new password input (for reset form)
        function validateNewPasswordInput() {
            const password = document.getElementById('newPassword').value;
            document.getElementById('new-req-length').className = password.length >= 8 ? 'valid' : '';
            document.getElementById('new-req-upper').className = /[A-Z]/.test(password) ? 'valid' : '';
            document.getElementById('new-req-lower').className = /[a-z]/.test(password) ? 'valid' : '';
            document.getElementById('new-req-number').className = /[0-9]/.test(password) ? 'valid' : '';
        }

        // Verify email via API
        async function verifyEmail(token) {
            try {
                const response = await fetch('https://api.getsignatures.org/auth/verify-email?token=' + encodeURIComponent(token));
                const data = await response.json();
                return data;
            } catch (error) {
                return { success: false, message: 'Could not verify email. Please try again.' };
            }
        }

        // Check if already authenticated on page load
        async function checkAuth() {
            await waitForDocSign();

            if (window.DocSign.isAuthenticated()) {
                // Already logged in, redirect to main page
                window.location.href = 'index.html';
            }

            // Check URL params
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const token = params.get('token');

            // Handle email verification from link
            if (action === 'verify' && token) {
                showAlert('Verifying your email...', 'success');
                const result = await verifyEmail(token);
                if (result.success) {
                    showAlert('Email verified! You can now sign in.', 'success');
                    // Clean URL
                    window.history.replaceState({}, '', 'auth.html');
                } else {
                    showAlert(result.message || 'Verification failed. The link may have expired.', 'error');
                }
                return;
            }

            // Handle password reset from link
            if (action === 'reset' && token) {
                document.getElementById('resetToken').value = token;
                showForm('resetPassword');
                // Clean URL but keep on page
                window.history.replaceState({}, '', 'auth.html?action=reset');
                return;
            }

            // Handle tab selection from URL (e.g., ?tab=register)
            if (params.get('tab') === 'register') {
                showForm('register');
            }

            // Check for verification success (legacy)
            if (params.get('verified') === 'true') {
                showAlert('Email verified successfully! You can now sign in.', 'success');
            }
            if (params.get('reset') === 'true') {
                showAlert('Password reset successfully! You can now sign in.', 'success');
            }
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
