#!/bin/bash
# Pre-commit hook aligned with CI workflow
# Install: ./scripts/install-hooks.sh
# Or manually: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If running from .git/hooks, find the project root differently
if [[ "$SCRIPT_DIR" == *".git/hooks"* ]]; then
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
else
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

echo "üîç Running pre-commit checks..."

cd "$PROJECT_ROOT"

# Format check
echo "  Checking formatting..."
if ! cargo fmt --all -- --check; then
    echo "‚ùå Formatting check failed. Run 'cargo fmt --all' to fix."
    exit 1
fi

# Clippy (with auto-fix for safe lints)
echo "  Running Clippy..."
CLIPPY_OUTPUT=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1) || {
    # Check if it's a simple/safe lint that can be auto-fixed (machine-applicable only)
    SAFE_LINTS="redundant_clone|needless_borrow|clone_on_copy|useless_conversion|needless_return"
    if echo "$CLIPPY_OUTPUT" | grep -qE "clippy::($SAFE_LINTS)"; then
        echo "  üîß Auto-fixing safe clippy lints..."
        cargo clippy --fix --allow-dirty --allow-staged --all-targets --all-features 2>/dev/null || true
        # Re-run clippy to verify fix worked
        if ! cargo clippy --all-targets --all-features -- -D warnings; then
            echo "‚ùå Clippy still has issues after auto-fix. Manual fix needed."
            exit 1
        fi
        echo "  ‚úÖ Auto-fix successful!"
    else
        echo "$CLIPPY_OUTPUT"
        echo "‚ùå Clippy found issues. Fix the warnings above."
        exit 1
    fi
}

# Unit tests (fast, no browser/server needed)
# Use cargo nextest for parallel execution if available, otherwise fall back to cargo test
echo "  Running unit tests..."
if command -v cargo-nextest &> /dev/null; then
    if ! cargo nextest run --all-features --workspace; then
        echo "‚ùå Unit tests failed."
        exit 1
    fi
else
    if ! cargo test --all-features --workspace; then
        echo "‚ùå Unit tests failed."
        exit 1
    fi
fi

# Parity tests (fast, catches config drift between apps)
echo "  Running parity tests..."
if command -v cargo-nextest &> /dev/null; then
    if ! cargo nextest run -p benchmark-harness --test parity_tests; then
        echo "‚ùå Parity tests failed. Apps may have diverged configs."
        exit 1
    fi
else
    if ! cargo test -p benchmark-harness --test parity_tests; then
        echo "‚ùå Parity tests failed. Apps may have diverged configs."
        exit 1
    fi
fi

# Browser tests (requires trunk servers)
# Skip if SKIP_BROWSER_TESTS is set or if we can't start servers
if [ -z "$SKIP_BROWSER_TESTS" ]; then
    echo "  Running browser integration tests..."
    if ! "$PROJECT_ROOT/scripts/test-browser.sh"; then
        echo "‚ùå Browser tests failed."
        echo "  To skip browser tests: SKIP_BROWSER_TESTS=1 git commit ..."
        exit 1
    fi
else
    echo "  ‚è≠Ô∏è  Skipping browser tests (SKIP_BROWSER_TESTS is set)"
fi

echo "‚úÖ All pre-commit checks passed!"
